<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <title>PDA JSON → Diagram</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #0f172a;
      color: #e5e7eb;
      margin: 0;
      padding: 1.5rem;
    }
    h1 {
      margin-top: 0;
      color: #f9fafb;
    }
    textarea {
      width: 100%;
      min-height: 200px;
      resize: vertical;
      padding: 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid #1f2937;
      background: #020617;
      color: #e5e7eb;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.85rem;
    }
    button {
      margin-top: 0.75rem;
      padding: 0.5rem 1.2rem;
      border-radius: 999px;
      border: none;
      background: #2563eb;
      color: #f9fafb;
      font-weight: 600;
      cursor: pointer;
    }
    button:hover {
      background: #1d4ed8;
    }
    #error {
      margin-top: 0.5rem;
      color: #fecaca;
      font-size: 0.9rem;
      white-space: pre-wrap;
    }
    #meta {
      margin-top: 1rem;
      font-size: 0.9rem;
    }
    .badge {
      display: inline-block;
      padding: 0.1rem 0.6rem;
      margin: 0.1rem 0.15rem;
      border-radius: 999px;
      background: #111827;
      font-size: 0.8rem;
    }
    #diagram-wrapper {
      margin-top: 1.5rem;
      border-radius: 0.75rem;
      border: 1px solid #1f2937;
      background: #020617;
      padding: 0.75rem;
      overflow: auto;
    }
    svg {
      background: #020617;
    }
  </style>
</head>
<body>
  <h1>PDA JSON → Diagram</h1>

  <p>Masukkan JSON PDA (states, startState, acceptStates, transitions):</p>
  <textarea id="json-input">
// contoh bawaan
{
  "states": ["q0", "q1", "q2", "q3", "qf"],
  "startState": "q0",
  "acceptStates": ["qf"],
  "transitions": [
    { "from": "q0", "to": "q1", "read": "λ", "pop": "λ", "push": "#" },
    { "from": "q1", "to": "q2", "read": "b", "pop": "#", "push": "#" },
    { "from": "q2", "to": "q2", "read": "b", "pop": "#", "push": "b#" },
    { "from": "q2", "to": "q2", "read": "b", "pop": "b", "push": "bb" },
    { "from": "q2", "to": "q3", "read": "a", "pop": "b", "push": "b" },
    { "from": "q3", "to": "q2", "read": "a", "pop": "b", "push": "λ" },
    { "from": "q2", "to": "qf", "read": "a", "pop": "#", "push": "#" }
  ]
}
  </textarea>
  <br />
  <button id="render-btn">Render Diagram</button>
  <div id="error"></div>
  <div id="meta"></div>

  <div id="diagram-wrapper">
    <svg id="diagram" width="800" height="300"></svg>
  </div>

  <script>
    const btn = document.getElementById('render-btn');
    const input = document.getElementById('json-input');
    const errorDiv = document.getElementById('error');
    const metaDiv = document.getElementById('meta');
    const svg = document.getElementById('diagram');

    function clearSVG() {
      while (svg.firstChild) svg.removeChild(svg.firstChild);
    }

    function createSVG(tag, attrs = {}) {
      const el = document.createElementNS('http://www.w3.org/2000/svg', tag);
      for (const [k, v] of Object.entries(attrs)) el.setAttribute(k, v);
      return el;
    }

    function renderMeta(pda) {
      metaDiv.innerHTML = '';
      const mkRow = (label, arr) => {
        const div = document.createElement('div');
        const strong = document.createElement('strong');
        strong.textContent = label + ': ';
        div.appendChild(strong);
        (arr || []).forEach(x => {
          const span = document.createElement('span');
          span.className = 'badge';
          span.textContent = x;
          div.appendChild(span);
        });
        return div;
      };
      metaDiv.appendChild(mkRow('States', pda.states || []));
      metaDiv.appendChild(mkRow('Start state', [pda.startState || '(none)']));
      metaDiv.appendChild(mkRow('Accept states', pda.acceptStates || []));
    }

    function renderDiagram(pda) {
      clearSVG();

      if (!pda.states || !Array.isArray(pda.states) || pda.states.length === 0) {
        throw new Error('JSON harus punya properti "states" berupa array.');
      }

      const states = pda.states;
      const n = states.length;

      // Layout sederhana: deret horizontal
      const radius = 26;
      const gapX = 150;
      const baseY = 150;
      const paddingLeft = 80;

      const width = Math.max(800, paddingLeft + gapX * (n));
      const height = 300;
      svg.setAttribute('width', width);
      svg.setAttribute('height', height);

      // Marker arrowhead
      const defs = createSVG('defs');
      const marker = createSVG('marker', {
        id: 'arrow',
        markerWidth: 10,
        markerHeight: 10,
        refX: 10,
        refY: 3,
        orient: 'auto',
        markerUnits: 'strokeWidth'
      });
      const arrowPath = createSVG('path', {
        d: 'M0,0 L10,3 L0,6 Z',
        fill: '#e5e7eb'
      });
      marker.appendChild(arrowPath);
      defs.appendChild(marker);
      svg.appendChild(defs);

      // Hitung posisi tiap state
      const positions = {};
      states.forEach((s, i) => {
        positions[s] = {
          x: paddingLeft + i * gapX,
          y: baseY
        };
      });

      // Gambar garis transisi dulu (di bawah)
      const transitions = pda.transitions || [];
      // Untuk offset bila ada beberapa transisi dari A ke B
      const pairCount = {};
      transitions.forEach(tr => {
        const key = tr.from + '->' + tr.to;
        pairCount[key] = (pairCount[key] || 0) + 1;
      });

      const pairIndex = {};
      transitions.forEach(tr => {
        const from = tr.from;
        const to = tr.to;
        if (!positions[from] || !positions[to]) return;

        const key = from + '->' + to;
        pairIndex[key] = (pairIndex[key] || 0) + 1;
        const idx = pairIndex[key];
        const count = pairCount[key];

        const p1 = positions[from];
        const p2 = positions[to];

        if (from === to) {
          // self-loop di atas node
          const loopRadius = radius + 15;
          const cx = p1.x;
          const cy = p1.y - radius - 10;
          const path = createSVG('path', {
            d: `M ${cx - 10} ${p1.y - radius}
                C ${cx - loopRadius} ${cy},
                  ${cx + loopRadius} ${cy},
                  ${cx + 10} ${p1.y - radius}`,
            fill: 'none',
            stroke: '#e5e7eb',
            'stroke-width': 1.7,
            'marker-end': 'url(#arrow)'
          });
          svg.appendChild(path);

          const label = createSVG('text', {
            x: cx,
            y: cy - 4,
            'text-anchor': 'middle',
            'font-size': '10'
          });
          const read = tr.read === 'λ' ? 'λ' : tr.read;
          const pop = tr.pop === 'λ' ? 'λ' : tr.pop;
          const push = tr.push === 'λ' ? 'λ' : tr.push;
          label.textContent = `${read},${pop}→${push}`;
          svg.appendChild(label);
        } else {
          const dx = p2.x - p1.x;
          const dy = p2.y - p1.y;
          const dist = Math.sqrt(dx*dx + dy*dy) || 1;
          const ux = dx / dist;
          const uy = dy / dist;

          // start & end di tepi lingkaran
          const startX = p1.x + ux * radius;
          const startY = p1.y + uy * radius;
          const endX = p2.x - ux * radius;
          const endY = p2.y - uy * radius;

          // offset untuk multiple edges antara dua state
          let offsetY = 0;
          if (count > 1) {
            const offsetStep = 10;
            const midIndex = (count + 1) / 2;
            offsetY = (idx - midIndex) * offsetStep;
          }

          const path = createSVG('path', {
            d: `M ${startX} ${startY}
                Q ${(startX + endX)/2} ${((startY + endY)/2) + offsetY},
                  ${endX} ${endY}`,
            fill: 'none',
            stroke: '#e5e7eb',
            'stroke-width': 1.7,
            'marker-end': 'url(#arrow)'
          });
          svg.appendChild(path);

          const midX = (startX + endX) / 2;
          const midY = ((startY + endY) / 2) + offsetY - 4;
          const label = createSVG('text', {
            x: midX,
            y: midY,
            'text-anchor': 'middle',
            'font-size': '10'
          });
          const read = tr.read === 'λ' ? 'λ' : tr.read;
          const pop = tr.pop === 'λ' ? 'λ' : tr.pop;
          const push = tr.push === 'λ' ? 'λ' : tr.push;
          label.textContent = `${read},${pop}→${push}`;
          svg.appendChild(label);
        }
      });

      // Gambar state (di atas garis)
      states.forEach(s => {
        const { x, y } = positions[s];
        const isAccept = (pda.acceptStates || []).includes(s);
        const isStart = pda.startState === s;

        // lingkaran utama
        const circle = createSVG('circle', {
          cx: x,
          cy: y,
          r: radius,
          fill: '#020617',
          stroke: '#e5e7eb',
          'stroke-width': 1.5
        });
        svg.appendChild(circle);

        // double circle untuk final
        if (isAccept) {
          const inner = createSVG('circle', {
            cx: x,
            cy: y,
            r: radius - 5,
            fill: 'none',
            stroke: '#22c55e',
            'stroke-width': 1.4
          });
          svg.appendChild(inner);
        }

        // label state
        const text = createSVG('text', {
          x: x,
          y: y + 4,
          'text-anchor': 'middle',
          'font-size': '12'
        });
        text.textContent = s;
        svg.appendChild(text);

        // panah start
        if (isStart) {
          const startArrow = createSVG('path', {
            d: `M ${x - radius - 35} ${y} L ${x - radius} ${y}`,
            stroke: '#22c55e',
            'stroke-width': 1.7,
            'marker-end': 'url(#arrow)'
          });
          svg.appendChild(startArrow);
        }
      });
    }

    btn.addEventListener('click', () => {
      errorDiv.textContent = '';
      try {
        const jsonText = input.value.trim();
        const pda = JSON.parse(jsonText);
        renderMeta(pda);
        renderDiagram(pda);
      } catch (e) {
        clearSVG();
        metaDiv.innerHTML = '';
        errorDiv.textContent = 'Error parsing/rendering JSON:\n' + e.message;
      }
    });

    // render pertama pakai contoh bawaan
    btn.click();
  </script>
</body>
</html>
